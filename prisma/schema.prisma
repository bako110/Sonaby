generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String                      @id @default(dbgenerated("(uuid())")) @db.Char(36)
  email               String                      @unique(map: "email") @db.VarChar(255)
  passwordHash        String                      @map("password_hash") @db.Text
  firstName           String                      @map("first_name") @db.VarChar(100)
  lastName            String                      @map("last_name") @db.VarChar(100)
  role                String                      @default("AGENT_CONTROLE") @db.VarChar(20)
  isActive            Boolean?                    @default(true) @map("is_active")
  phone               String?                     @db.VarChar(20)
  createdAt           DateTime?                   @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt           DateTime?                   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  agentAssignments    AgentCheckpointAssignment[]
  auditLogs           AuditLog[]
  blacklistActions    BlacklistHistory[]
  organizedRendezvous Rendezvous[]                @relation("RendezvousOrganizer")
  serviceChef         Service[]                   @relation("ServiceChef")
  triggeredSosAlerts  SosAlert[]                  @relation("SosTriggerer")
  resolvedSosAlerts   SosAlert[]                  @relation("SosResolver")
  user_roles          user_roles                  @relation(fields: [role], references: [role_name], onDelete: NoAction, onUpdate: NoAction, map: "users_ibfk_1")
  reportedIncidents   VisitIncident[]             @relation("IncidentReporter")
  organizedGroups     VisitorGroup[]
  createdVisits       Visit[]                     @relation("VisitCreator")
  refreshTokens       RefreshToken[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Site {
  id          String       @id @default(dbgenerated("(uuid())")) @db.Char(36)
  name        String       @db.VarChar(255)
  address     String       @db.Text
  phone       String?      @db.VarChar(20)
  isActive    Boolean?     @default(true) @map("is_active")
  createdAt   DateTime?    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt   DateTime?    @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  checkpoints Checkpoint[]

  @@map("sites")
}

model Checkpoint {
  id                  String                      @id @default(dbgenerated("(uuid())")) @db.Char(36)
  siteId              String                      @map("site_id") @db.Char(36)
  name                String                      @db.VarChar(255)
  sosCode             String                      @unique(map: "sos_code") @map("sos_code") @db.VarChar(100)
  locationDescription String?                     @map("location_description") @db.Text
  isActive            Boolean?                    @default(true) @map("is_active")
  createdAt           DateTime?                   @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt           DateTime?                   @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  agentAssignments    AgentCheckpointAssignment[]
  site                Site                        @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "checkpoints_ibfk_1")
  sosAlerts           SosAlert[]
  visits              Visit[]

  @@index([siteId], map: "idx_checkpoints_site_id")
  @@index([sosCode], map: "idx_checkpoints_sos_code")
  @@map("checkpoints")
}

model AgentCheckpointAssignment {
  id           String     @id @default(dbgenerated("(uuid())")) @db.Char(36)
  userId       String     @map("user_id") @db.Char(36)
  checkpointId String     @map("checkpoint_id") @db.Char(36)
  startDate    DateTime   @map("start_date") @db.Timestamp(0)
  endDate      DateTime?  @map("end_date") @db.Timestamp(0)
  createdAt    DateTime?  @default(now()) @map("created_at") @db.Timestamp(0)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "agent_checkpoint_assignments_ibfk_1")
  checkpoint   Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "agent_checkpoint_assignments_ibfk_2")

  @@unique([userId, checkpointId, startDate], map: "unique_assignment")
  @@index([checkpointId], map: "idx_agent_assignments_checkpoint_id")
  @@index([userId], map: "idx_agent_assignments_user_id")
  @@map("agent_checkpoint_assignments")
}

model Visitor {
  id               String             @id @default(dbgenerated("(uuid())")) @db.Char(36)
  firstName        String             @map("first_name") @db.VarChar(100)
  lastName         String             @map("last_name") @db.VarChar(100)
  phone            String?            @db.VarChar(20)
  email            String?            @db.VarChar(255)
  idType           String             @map("id_type") @db.VarChar(20)
  idNumber         String             @map("id_number") @db.VarChar(255)
  idScanUrl        String?            @map("id_scan_url") @db.Text
  photoUrl         String?            @map("photo_url") @db.Text
  isBlacklisted    Boolean?           @default(false) @map("is_blacklisted")
  blacklistReason  String?            @map("blacklist_reason") @db.Text
  company          String?            @db.VarChar(255)
  createdAt        DateTime?          @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt        DateTime?          @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  blacklistHistory BlacklistHistory[]
  groupMemberships GroupVisitor[]
  rendezvous       Rendezvous[]
  id_types         id_types           @relation(fields: [idType], references: [type_name], onDelete: NoAction, onUpdate: NoAction, map: "visitors_ibfk_1")
  visits           Visit[]

  @@unique([idType, idNumber], map: "unique_identity")
  @@index([isBlacklisted], map: "idx_visitors_blacklisted")
  @@index([idNumber], map: "idx_visitors_id_number")
  @@map("visitors")
}

model Service {
  id            String         @id @default(dbgenerated("(uuid())")) @db.Char(36)
  name          String         @db.VarChar(255)
  description   String?        @db.Text
  chefId        String?        @map("chef_id") @db.Char(36)
  isActive      Boolean?       @default(true) @map("is_active")
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt     DateTime?      @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  rendezvous    Rendezvous[]
  chef          User?          @relation("ServiceChef", fields: [chefId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "services_ibfk_1")
  visitorGroups VisitorGroup[]
  visits        Visit[]

  @@index([chefId], map: "chef_id")
  @@map("services")
}

model Rendezvous {
  id                  String               @id @default(dbgenerated("(uuid())")) @db.Char(36)
  organizerId         String               @map("organizer_id") @db.Char(36)
  visitorId           String?              @map("visitor_id") @db.Char(36)
  groupCode           String?              @map("group_code") @db.VarChar(100)
  serviceId           String               @map("service_id") @db.Char(36)
  reason              String               @db.Text
  visitDate           DateTime             @map("visit_date") @db.Date
  startTime           DateTime?            @map("start_time") @db.Time(0)
  endTime             DateTime?            @map("end_time") @db.Time(0)
  qrCode              String               @unique(map: "qr_code") @map("qr_code") @db.VarChar(255)
  status              String?              @default("pending") @db.VarChar(20)
  notes               String?              @db.Text
  createdAt           DateTime?            @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt           DateTime?            @default(now()) @updatedAt @map("updated_at") @db.Timestamp(0)
  organizer           User                 @relation("RendezvousOrganizer", fields: [organizerId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "rendezvous_ibfk_1")
  visitor             Visitor?             @relation(fields: [visitorId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "rendezvous_ibfk_2")
  service             Service              @relation(fields: [serviceId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "rendezvous_ibfk_3")
  rendezvous_statuses rendezvous_statuses? @relation(fields: [status], references: [status_name], onDelete: NoAction, onUpdate: NoAction, map: "rendezvous_ibfk_4")
  visits              Visit[]

  @@index([qrCode], map: "idx_rendezvous_qr_code")
  @@index([visitDate], map: "idx_rendezvous_visit_date")
  @@index([organizerId], map: "organizer_id")
  @@index([serviceId], map: "service_id")
  @@index([status], map: "status")
  @@index([visitorId], map: "visitor_id")
  @@map("rendezvous")
}

model Visit {
  id             String          @id @default(dbgenerated("(uuid())")) @db.Char(36)
  visitorId      String          @map("visitor_id") @db.Char(36)
  checkpointId   String          @map("checkpoint_id") @db.Char(36)
  serviceId      String          @map("service_id") @db.Char(36)
  reason         String          @db.Text
  plannedId      String?         @map("planned_id") @db.Char(36)
  isGroup        Boolean?        @default(false) @map("is_group")
  groupCode      String?         @map("group_code") @db.VarChar(100)
  entryTime      DateTime        @map("entry_time") @db.Timestamp(0)
  exitTime       DateTime?       @map("exit_time") @db.Timestamp(0)
  createdBy      String          @map("created_by") @db.Char(36)
  status         String?         @default("active") @db.VarChar(20)
  signatureUrl   String?         @map("signature_url") @db.Text
  notes          String?         @db.Text
  createdAt      DateTime?       @default(now()) @map("created_at") @db.Timestamp(0)
  incidents      VisitIncident[]
  visitor        Visitor         @relation(fields: [visitorId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "visits_ibfk_1")
  checkpoint     Checkpoint      @relation(fields: [checkpointId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visits_ibfk_2")
  service        Service         @relation(fields: [serviceId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visits_ibfk_3")
  planned        Rendezvous?     @relation(fields: [plannedId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visits_ibfk_4")
  creator        User            @relation("VisitCreator", fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visits_ibfk_5")
  visit_statuses visit_statuses? @relation(fields: [status], references: [status_name], onDelete: NoAction, onUpdate: NoAction, map: "visits_ibfk_6")

  @@index([checkpointId], map: "checkpoint_id")
  @@index([createdBy], map: "created_by")
  @@index([entryTime], map: "idx_visits_entry_time")
  @@index([exitTime], map: "idx_visits_exit_time")
  @@index([plannedId], map: "idx_visits_planned_id")
  @@index([visitorId], map: "idx_visits_visitor_id")
  @@index([serviceId], map: "service_id")
  @@index([status], map: "status")
  @@map("visits")
}

model VisitIncident {
  id              String    @id @default(dbgenerated("(uuid())")) @db.Char(36)
  visitId         String    @map("visit_id") @db.Char(36)
  reportedBy      String    @map("reported_by") @db.Char(36)
  title           String    @db.VarChar(255)
  description     String    @db.Text
  severityLevel   Int?      @default(1) @map("severity_level")
  isResolved      Boolean?  @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamp(0)
  resolutionNotes String?   @map("resolution_notes") @db.Text
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamp(0)
  visit           Visit     @relation(fields: [visitId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "visit_incidents_ibfk_1")
  reporter        User      @relation("IncidentReporter", fields: [reportedBy], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visit_incidents_ibfk_2")

  @@index([reportedBy], map: "reported_by")
  @@index([visitId], map: "visit_id")
  @@map("visit_incidents")
}

model SosAlert {
  id              String     @id @default(dbgenerated("(uuid())")) @db.Char(36)
  checkpointId    String     @map("checkpoint_id") @db.Char(36)
  triggeredBy     String     @map("triggered_by") @db.Char(36)
  triggeredAt     DateTime?  @default(now()) @map("triggered_at") @db.Timestamp(0)
  message         String?    @db.Text
  isResolved      Boolean?   @default(false) @map("is_resolved")
  resolvedAt      DateTime?  @map("resolved_at") @db.Timestamp(0)
  resolvedBy      String?    @map("resolved_by") @db.Char(36)
  resolutionNotes String?    @map("resolution_notes") @db.Text
  checkpoint      Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "sos_alerts_ibfk_1")
  triggerer       User       @relation("SosTriggerer", fields: [triggeredBy], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "sos_alerts_ibfk_2")
  resolver        User?      @relation("SosResolver", fields: [resolvedBy], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "sos_alerts_ibfk_3")

  @@index([checkpointId], map: "idx_sos_alerts_checkpoint_id")
  @@index([triggeredAt], map: "idx_sos_alerts_triggered_at")
  @@index([resolvedBy], map: "resolved_by")
  @@index([triggeredBy], map: "triggered_by")
  @@map("sos_alerts")
}

model BlacklistHistory {
  id                String            @id @default(dbgenerated("(uuid())")) @db.Char(36)
  visitorId         String            @map("visitor_id") @db.Char(36)
  action            String            @db.VarChar(20)
  reason            String            @db.Text
  createdBy         String            @map("created_by") @db.Char(36)
  createdAt         DateTime?         @default(now()) @map("created_at") @db.Timestamp(0)
  visitor           Visitor           @relation(fields: [visitorId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "blacklist_history_ibfk_1")
  blacklist_actions blacklist_actions @relation(fields: [action], references: [action_name], onDelete: NoAction, onUpdate: NoAction, map: "blacklist_history_ibfk_2")
  creator           User              @relation(fields: [createdBy], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "blacklist_history_ibfk_3")

  @@index([action], map: "action")
  @@index([createdBy], map: "created_by")
  @@index([visitorId], map: "visitor_id")
  @@map("blacklist_history")
}

model AuditLog {
  id        String    @id @default(dbgenerated("(uuid())")) @db.Char(36)
  userId    String?   @map("user_id") @db.Char(36)
  action    String    @db.VarChar(255)
  entity    String    @db.VarChar(255)
  entityId  String?   @map("entity_id") @db.Char(36)
  oldValues Json?     @map("old_values")
  newValues Json?     @map("new_values")
  ipAddress String?   @map("ip_address") @db.VarChar(45)
  userAgent String?   @map("user_agent") @db.Text
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(0)
  user      User?     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "audit_logs_ibfk_1")

  @@index([createdAt], map: "idx_audit_logs_created_at")
  @@index([entity, entityId], map: "idx_audit_logs_entity")
  @@index([userId], map: "user_id")
  @@map("audit_logs")
}

model VisitorGroup {
  id            String         @id @default(dbgenerated("(uuid())")) @db.Char(36)
  groupCode     String         @unique(map: "group_code") @map("group_code") @db.VarChar(100)
  organizerId   String         @map("organizer_id") @db.Char(36)
  serviceId     String         @map("service_id") @db.Char(36)
  reason        String         @db.Text
  visitDate     DateTime       @map("visit_date") @db.Date
  expectedCount Int?           @default(1) @map("expected_count")
  notes         String?        @db.Text
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamp(0)
  visitors      GroupVisitor[]
  organizer     User           @relation(fields: [organizerId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visitor_groups_ibfk_1")
  service       Service        @relation(fields: [serviceId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "visitor_groups_ibfk_2")

  @@index([organizerId], map: "organizer_id")
  @@index([serviceId], map: "service_id")
  @@map("visitor_groups")
}

model GroupVisitor {
  id        String       @id @default(dbgenerated("(uuid())")) @db.Char(36)
  groupId   String       @map("group_id") @db.Char(36)
  visitorId String       @map("visitor_id") @db.Char(36)
  createdAt DateTime?    @default(now()) @map("created_at") @db.Timestamp(0)
  group     VisitorGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "group_visitors_ibfk_1")
  visitor   Visitor      @relation(fields: [visitorId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "group_visitors_ibfk_2")

  @@unique([groupId, visitorId], map: "unique_group_visitor")
  @@index([visitorId], map: "visitor_id")
  @@map("group_visitors")
}

model blacklist_actions {
  action_name       String             @id @db.VarChar(20)
  blacklist_history BlacklistHistory[]
}

model id_types {
  type_name String    @id @db.VarChar(20)
  visitors  Visitor[]
}

model rendezvous_statuses {
  status_name String       @id @db.VarChar(20)
  rendezvous  Rendezvous[]
}

model user_roles {
  role_name String @id @db.VarChar(20)
  users     User[]
}

model visit_statuses {
  status_name String  @id @db.VarChar(20)
  visits      Visit[]
}

model RefreshToken {
  id        String   @id @default(dbgenerated("(uuid())")) @db.Char(36)
  token     String   @unique @db.VarChar(500)
  userId    String   @map("user_id") @db.Char(36)
  expiresAt DateTime @map("expires_at") @db.Timestamp(0)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(0)
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId], map: "idx_refresh_tokens_user_id")
  @@index([expiresAt], map: "idx_refresh_tokens_expires_at")
  @@map("refresh_tokens")
}
