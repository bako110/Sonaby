// Prisma Schema Definition - Correspondant au schéma PostgreSQL
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums correspondant à PostgreSQL
enum UserRole {
  ADMIN
  AGENT_GESTION
  AGENT_CONTROLE
  CHEF_SERVICE

  @@map("user_role")
}

enum IdTypeEnum {
  CNI
  PASSEPORT
  PERMIS_CONDUITE
  CARTE_SEJOUR
  AUTRE

  @@map("id_type_enum")
}

enum RendezvousStatus {
  pending
  validated
  cancelled

  @@map("rendezvous_status")
}

enum VisitStatus {
  active
  finished
  refused

  @@map("visit_status")
}

enum BlacklistAction {
  added
  removed

  @@map("blacklist_action")
}

// 1. Table users (tous les utilisateurs du système)
model User {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String   @map("first_name")
  lastName      String   @map("last_name")
  role          UserRole @default(AGENT_CONTROLE)
  isActive      Boolean  @default(true) @map("is_active")
  phone         String?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  agentAssignments     AgentCheckpointAssignment[]
  organizedRendezvous  Rendezvous[]                @relation("RendezvousOrganizer")
  createdVisits        Visit[]                     @relation("VisitCreator")
  reportedIncidents    VisitIncident[]             @relation("IncidentReporter")
  resolvedIncidents    VisitIncident[]             @relation("IncidentResolver")
  triggeredSosAlerts   SosAlert[]                  @relation("SosTriggerer")
  resolvedSosAlerts    SosAlert[]                  @relation("SosResolver")
  blacklistActions     BlacklistHistory[]
  auditLogs            AuditLog[]
  organizedGroups      VisitorGroup[]
  serviceChef          Service[]                   @relation("ServiceChef")
  refreshTokens        RefreshToken[]

  @@map("users")
}

// 2. Table sites (chaque site de l'entreprise)
model Site {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  address   String
  phone     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  checkpoints Checkpoint[]

  @@map("sites")
}

// 3. Table checkpoints (les postes de contrôle / tablettes)
model Checkpoint {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  siteId              String   @map("site_id") @db.Uuid
  name                String
  sosCode             String   @unique @map("sos_code")
  locationDescription String?  @map("location_description")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  site            Site                        @relation(fields: [siteId], references: [id], onDelete: Cascade)
  agentAssignments AgentCheckpointAssignment[]
  visits          Visit[]
  sosAlerts       SosAlert[]

  @@map("checkpoints")
}

// 4. Table agent_checkpoint_assignments (Affectation des agents)
model AgentCheckpointAssignment {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  checkpointId String    @map("checkpoint_id") @db.Uuid
  startDate    DateTime  @map("start_date") @db.Timestamptz(6)
  endDate      DateTime? @map("end_date") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  checkpoint Checkpoint @relation(fields: [checkpointId], references: [id], onDelete: Cascade)

  @@unique([userId, checkpointId, startDate])
  @@map("agent_checkpoint_assignments")
}

// 5. Table visitors (identité du visiteur)
model Visitor {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName        String      @map("first_name")
  lastName         String      @map("last_name")
  phone            String?
  email            String?
  idType           IdTypeEnum  @map("id_type")
  idNumber         String      @map("id_number")
  idScanUrl        String?     @map("id_scan_url")
  photoUrl         String?     @map("photo_url")
  isBlacklisted    Boolean     @default(false) @map("is_blacklisted")
  blacklistReason  String?     @map("blacklist_reason")
  company          String?
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime    @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  rendezvous       Rendezvous[]
  visits           Visit[]
  blacklistHistory BlacklistHistory[]
  groupMemberships GroupVisitor[]

  @@unique([idType, idNumber])
  @@map("visitors")
}

// 6. Table services (départements visitables)
model Service {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  chefId      String?  @map("chef_id") @db.Uuid
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  chef          User?           @relation("ServiceChef", fields: [chefId], references: [id])
  rendezvous    Rendezvous[]
  visits        Visit[]
  visitorGroups VisitorGroup[]

  @@map("services")
}

// 7. Table rendezvous (pré-enregistrement)
model Rendezvous {
  id          String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizerId String            @map("organizer_id") @db.Uuid
  visitorId   String?           @map("visitor_id") @db.Uuid
  groupCode   String?           @map("group_code")
  serviceId   String            @map("service_id") @db.Uuid
  reason      String
  visitDate   DateTime          @map("visit_date") @db.Date
  startTime   DateTime?         @map("start_time") @db.Time(6)
  endTime     DateTime?         @map("end_time") @db.Time(6)
  qrCode      String            @unique @map("qr_code")
  status      RendezvousStatus  @default(pending)
  notes       String?
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime          @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  organizer User     @relation("RendezvousOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  visitor   Visitor? @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  service   Service  @relation(fields: [serviceId], references: [id])
  visits    Visit[]

  @@map("rendezvous")
}

// 8. Table visits (visite réelle)
model Visit {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  visitorId    String      @map("visitor_id") @db.Uuid
  checkpointId String      @map("checkpoint_id") @db.Uuid
  serviceId    String      @map("service_id") @db.Uuid
  reason       String
  plannedId    String?     @map("planned_id") @db.Uuid
  isGroup      Boolean     @default(false) @map("is_group")
  groupCode    String?     @map("group_code")
  entryTime    DateTime    @map("entry_time") @db.Timestamptz(6)
  exitTime     DateTime?   @map("exit_time") @db.Timestamptz(6)
  createdBy    String      @map("created_by") @db.Uuid
  status       VisitStatus @default(active)
  signatureUrl String?     @map("signature_url")
  notes        String?
  createdAt    DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  visitor    Visitor         @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  checkpoint Checkpoint      @relation(fields: [checkpointId], references: [id])
  service    Service         @relation(fields: [serviceId], references: [id])
  planned    Rendezvous?     @relation(fields: [plannedId], references: [id])
  creator    User            @relation("VisitCreator", fields: [createdBy], references: [id])
  incidents  VisitIncident[]

  @@map("visits")
}

// 9. Table visit_incidents (déclarations incidents)
model VisitIncident {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  visitId         String    @map("visit_id") @db.Uuid
  reportedBy      String    @map("reported_by") @db.Uuid
  title           String
  description     String
  severityLevel   Int       @default(1) @map("severity_level")
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolvedBy      String?   @map("resolved_by") @db.Uuid
  resolutionNotes String?   @map("resolution_notes")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  visit    Visit @relation(fields: [visitId], references: [id], onDelete: Cascade)
  reporter User  @relation("IncidentReporter", fields: [reportedBy], references: [id])
  resolver User? @relation("IncidentResolver", fields: [resolvedBy], references: [id])

  @@map("visit_incidents")
}

// 10. Table sos_alerts (gestion des SOS)
model SosAlert {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  checkpointId    String    @map("checkpoint_id") @db.Uuid
  triggeredBy     String    @map("triggered_by") @db.Uuid
  triggeredAt     DateTime  @default(now()) @map("triggered_at") @db.Timestamptz(6)
  message         String?
  isResolved      Boolean   @default(false) @map("is_resolved")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  resolvedBy      String?   @map("resolved_by") @db.Uuid
  resolutionNotes String?   @map("resolution_notes")

  // Relations
  checkpoint Checkpoint @relation(fields: [checkpointId], references: [id])
  triggerer  User       @relation("SosTriggerer", fields: [triggeredBy], references: [id])
  resolver   User?      @relation("SosResolver", fields: [resolvedBy], references: [id])

  @@map("sos_alerts")
}

// 11. Table blacklist_history (historique des indésirables)
model BlacklistHistory {
  id        String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  visitorId String          @map("visitor_id") @db.Uuid
  action    BlacklistAction
  reason    String
  createdBy String          @map("created_by") @db.Uuid
  createdAt DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  visitor Visitor @relation(fields: [visitorId], references: [id], onDelete: Cascade)
  creator User    @relation(fields: [createdBy], references: [id])

  @@map("blacklist_history")
}

// 12. Table audit_logs (sécurité + traçabilité RGPD)
model AuditLog {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  action     String
  entity     String
  entityId   String?   @map("entity_id") @db.Uuid
  oldValues  Json?     @map("old_values") @db.JsonB
  newValues  Json?     @map("new_values") @db.JsonB
  ipAddress  String?   @map("ip_address") @db.Inet
  userAgent  String?   @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

// 13. Table visitor_groups (pour les visites de groupe)
model VisitorGroup {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupCode     String   @unique @map("group_code")
  organizerId   String   @map("organizer_id") @db.Uuid
  serviceId     String   @map("service_id") @db.Uuid
  reason        String
  visitDate     DateTime @map("visit_date") @db.Date
  expectedCount Int      @default(1) @map("expected_count")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  organizer User           @relation(fields: [organizerId], references: [id])
  service   Service        @relation(fields: [serviceId], references: [id])
  visitors  GroupVisitor[]

  @@map("visitor_groups")
}

// 14. Table group_visitors (liens groupe-visiteurs)
model GroupVisitor {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  visitorId String   @map("visitor_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  group   VisitorGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  visitor Visitor      @relation(fields: [visitorId], references: [id], onDelete: Cascade)

  @@unique([groupId, visitorId])
  @@map("group_visitors")
}

// 15. Table refresh_tokens (pour l'authentification JWT)
model RefreshToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token     String   @unique
  userId    String   @map("user_id") @db.Uuid
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}
